# Copyright The ORAS Authors.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Tests

on:
  push:
    branches:
      - main
      - release-*
  pull_request:
    branches:
      - main
      - release-*

defaults:
  run:
    shell: bash

jobs:
  test-basic-setup:
    name: Test Setup ORAS CLI
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
        version:
          - 1.0.1
          - 1.1.0
      fail-fast: true
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup ORAS v${{ matrix.version }}
      uses: ./
      with:
        version: ${{ matrix.version }}

    - name: Verify ORAS version installed
      env:
        ORAS_VERSION_EXPECTED: ${{ matrix.version }}
      run: |
        echo ---
        oras version
        echo ---
        read -ra ORAS_VERSION_INSTALLED <<<$(oras version)
        [ "${ORAS_VERSION_INSTALLED[1]}" == "$ORAS_VERSION_EXPECTED" ]

  test-custom-url:
    name: Test Setup using URL
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup ORAS using URL
      uses: ./
      with:
        url: https://github.com/oras-project/oras/releases/download/v1.0.0/oras_1.0.0_linux_amd64.tar.gz
        checksum: "8533c9ea1e5a0d5eb1dfc5094c0e8ef106d15462f8a119077548f88937ed2133"

    - name: Setup ORAS using URL without checksum
      id: no-checksum
      continue-on-error: true
      uses: ./
      with:
        url: https://github.com/oras-project/oras/releases/download/v1.0.0/oras_1.0.0_linux_amd64.tar.gz
    - name: 'Should Fail: Setup ORAS using URL without checksum'
      if: steps.no-checksum.outcome != 'failure'
      run: |
        echo "Setup ORAS using URL without checksum should fail, but succeeded."
        exit 1
    
    - name: Setup ORAS using URL and invalid checksum
      id: invalid-checksum
      continue-on-error: true
      uses: ./
      with:
        url: https://github.com/oras-project/oras/releases/download/v1.0.0/oras_1.0.0_linux_amd64.tar.gz
        checksum: abcedf
    - name: 'Should Fail: Setup ORAS using URL and invalid checksum'
      if: steps.invalid-checksum.outcome != 'failure'
      run: |
        echo "Setup ORAS using URL and invalid checksum should fail, but succeeded."
        exit 1
    
    - name: Setup ORAS using invalid URL
      id: invalid-url
      continue-on-error: true
      uses: ./
      with:
        url: invalid-url
        checksum: test
    - name: 'Should Fail: Setup ORAS using invalid URL'
      if: steps.invalid-url.outcome != 'failure'
      run: |
        echo "Setup ORAS using invalid URL should fail, but succeeded."
        exit 1
